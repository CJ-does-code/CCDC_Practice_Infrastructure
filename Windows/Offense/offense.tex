\documentclass{article}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{tikzsymbols}
\usepackage{float}
\usepackage{epigraph}

\lstset{
    basicstyle=\ttfamily,
    backgroundcolor=\color{gray!30},
}

\renewcommand{\epigraphflush}{flushleft}

\begin{document}

\graphicspath{ {./Images/} }

\title{Windows Offense}

\tableofcontents

\section{Introduction}
\epigraph{If you know the enemy and know yourself, you need not fear the result of a hundred battles.}{Sun Tzu}

To be a good blue team, we should practice red teaming.

\section{Covenant Malware}
Covenant is a .NET command and control framework. It works by installing
Grunts on the target machine. Grunts work like reverse shells, they connect to a listener on 
the C2 server.

You should install covenant on whatever computer you
plan to use as the C2 server. This will let you control the windows machines. 
Covenant requires GIT and .NET to work. 
You will also need to install .NET on the victim machine.

\begin{itemize}
        \item\href{https://github.com/cobbr/Covenant/wiki/Installation-And-Startup}{Instructions on their GitHub}
        \item \href{https://blog.netwrix.com/2022/12/16/covenant-c2-tutorial/}{Blog Tutorial}
        \item \href{https://github.com/cobbr/Covenant-wiki/blob/master/Listeners.md}{More information on listeners}
\end{itemize}

To install GIT on windows, go here:
\href{https://git-scm.com/download/win}{https://git-scm.com/download/win}

To install .NET, you can download it from the
\href{https://dotnet.microsoft.com/en-us/download}{website} or you can install it in server manager (in the "Features" menu).

To install .NET on linux, follow these 
\href{https://learn.microsoft.com/en-us/dotnet/core/install/linux-scripted-manual#scripted-install}{directions}


After installing the dependencies, we can install and run covenant with:

\begin{lstlisting}
git clone --recurse-submodules https://github.com/cobbr/Covenant
cd Covenant/Covenant
dotnet build
dotnet run
\end{lstlisting}

"After running these commands, the Covenant service should be up and running. 
You can then browse to the Covenant application interface on its default web port of 
7443 to set up a user account and begin using the framework." -Bing

If you would like to have listeners on ports 1-1023, you should run Covenant as root.

The web console can be accessed at https://127.0.0.1:7443 and not localhost:7443, as the https is important

For the Grunt to work, .NET has to be installed on the victim.

Anti Grunt countermeasures:
"If you uninstall the .NET Framework 3.5 from the victim machine, 
it is likely that the Grunt will stop working." -Bing.
I think it is very funny that malware has dependencies.

\subsection{Troubleshooting the VPN}
I tried a lot of ways to get the Grunt to recognize my machine.
The only solutions that worked are a Kali VM or \href{sec:CloudflareTunnels}{Cloudflare Tunnels}.

To get your IP address from the RDP connection:
\begin{enumerate}
\item Open the Command Prompt by pressing the Windows key + R and typing cmd.
\item Type netstat -n | find ":3389" and press Enter. This will display a list of active connections to the RDP port (3389).
\item Look for the connection that corresponds to your RDP session. The IP address of the RDP client will be listed next to the ESTABLISHED entry.
\end{enumerate}

\href{https://youtu.be/Fi0jXm8VOFU}{Advanced Usage of Covenant}

\section{Cloudflare Tunnels}
\label{sec:CloudflareTunnels}

Justin mentioned how he was going to connect to the machines using cloudflare tunnels. So I will practice that and document it.

You can use your own domain, or you can have cloudflare provide one for you.

You need to install cloudflared on the machines you are connecting to

So to install on proxmox:
wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb \&\& sudo dpkg -i cloudflared-linux-amd64.deb

To do it without a domain: cloudflared tunnel --url http://localhost:80

Take note of the random url generated.

cloudflared access tcp --hostname randomsubdomain.trycloudflare.com --url tcp://localhost:5900

\section{BloodHound}

\section{WinPeas}
Windows Privilege Escalation Scripts.

This script dumps a bunch of information about potentially interesting things to look for on
 the windows machine. It can be found \href{https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS}{here}.
 

\section{SMBGhost / EternalDarkness / CVE-2020-0796}
https://blog.zecops.com/research/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/
https://github.com/carbonblack/tau-tools/tree/master/remediation/EternalDarkness
https://blogs.vmware.com/security/2020/03/threat-analysis-cve-2020-0796-eternaldarkness-ghostsmb.html
https://www.cisa.gov/news-events/alerts/2020/06/05/unpatched-microsoft-systems-vulnerable-cve-2020-0796

\section{Malware to look into}
Here is some random stuff so I don't forget to look into it:
https://github.com/0x44F/WinKit, https://github.com/D4stiny/spectre, this guy's stuff: https://github.com/DarkCoderSc?tab=repositories,
https://en.wikipedia.org/wiki/DarkComet, (infected file, do not run on main OS): https://github.com/zxo2004/DarkComet-RAT-5.3.1,
https://github.com/quasar/Quasar, https://github.com/screetsec/TheFatRat, https://github.com/DarkCoderSc/win-brute-logon

\section{Legitimate Administration Software}
https://www.islonline.com/us/en/
https://devolutions.net/remote-desktop-manager/

\end{document}

